{"version":3,"sources":["../../../lib/csv/csv.js"],"names":["fs","require","csv","dayjs","PromiseLib","StreamBuf","utils","CSV","module","exports","workbook","worksheet","SpecialValues","error","prototype","readFile","filename","options","self","stream","exists","then","Error","createReadStream","read","close","Promise","resolve","reject","csvStream","createInputStream","on","pipe","addWorksheet","sheetName","dateFormats","ISO_8601","map","datum","datumNumber","Number","isNaN","dt","isValid","Date","valueOf","special","undefined","data","addRow","emit","write","getWorksheet","sheetId","createWriteStream","dateFormat","dateUTC","value","text","hyperlink","formula","result","utc","format","JSON","stringify","includeEmptyRows","lastRow","eachRow","row","rowNumber","values","shift","end","writeFile","streamOptions","encoding","writeBuffer"],"mappings":"AAAA;;;;AAEA,IAAMA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAlB;;AACA,IAAMC,GAAG,GAAGD,OAAO,CAAC,UAAD,CAAnB;;AACA,IAAME,KAAK,GAAGF,OAAO,CAAC,OAAD,CAArB;;AACA,IAAMG,UAAU,GAAGH,OAAO,CAAC,kBAAD,CAA1B;;AACA,IAAMI,SAAS,GAAGJ,OAAO,CAAC,qBAAD,CAAzB;;AAEA,IAAMK,KAAK,GAAGL,OAAO,CAAC,gBAAD,CAArB;;AAEA,IAAMM,GAAG,GAAIC,MAAM,CAACC,OAAP,GAAiB,UAASC,QAAT,EAAmB;AAC/C,OAAKA,QAAL,GAAgBA,QAAhB;AACA,OAAKC,SAAL,GAAiB,IAAjB;AACD,CAHD;AAKA;;;AACA,IAAMC,aAAa,GAAG;AACpB,UAAM,IADc;AAEpB,WAAO,KAFa;AAGpB,UAAQ;AAAEC,IAAAA,KAAK,EAAE;AAAT,GAHY;AAIpB,WAAS;AAAEA,IAAAA,KAAK,EAAE;AAAT,GAJW;AAKpB,YAAU;AAAEA,IAAAA,KAAK,EAAE;AAAT,GALU;AAMpB,aAAW;AAAEA,IAAAA,KAAK,EAAE;AAAT,GANS;AAOpB,YAAU;AAAEA,IAAAA,KAAK,EAAE;AAAT,GAPU;AAQpB,aAAW;AAAEA,IAAAA,KAAK,EAAE;AAAT,GARS;AASpB,WAAS;AAAEA,IAAAA,KAAK,EAAE;AAAT;AATW,CAAtB;AAWA;;AAEAN,GAAG,CAACO,SAAJ,GAAgB;AACdC,EAAAA,QADc,oBACLC,QADK,EACKC,OADL,EACc;AAC1B,QAAMC,IAAI,GAAG,IAAb;AACAD,IAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACA,QAAIE,MAAJ;AACA,WAAOb,KAAK,CAACN,EAAN,CACJoB,MADI,CACGJ,QADH,EAEJK,IAFI,CAEC,UAAAD,MAAM,EAAI;AACd,UAAI,CAACA,MAAL,EAAa;AACX,cAAM,IAAIE,KAAJ,2BAA6BN,QAA7B,EAAN;AACD;;AACDG,MAAAA,MAAM,GAAGnB,EAAE,CAACuB,gBAAH,CAAoBP,QAApB,CAAT;AACA,aAAOE,IAAI,CAACM,IAAL,CAAUL,MAAV,EAAkBF,OAAlB,CAAP;AACD,KARI,EASJI,IATI,CASC,UAAAV,SAAS,EAAI;AACjBQ,MAAAA,MAAM,CAACM,KAAP;AACA,aAAOd,SAAP;AACD,KAZI,CAAP;AAaD,GAlBa;AAmBda,EAAAA,IAnBc,gBAmBTL,MAnBS,EAmBDF,OAnBC,EAmBQ;AAAA;;AACpBA,IAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACA,WAAO,IAAIb,UAAU,CAACsB,OAAf,CAAuB,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACjD,UAAMC,SAAS,GAAG,KAAI,CAACC,iBAAL,CAAuBb,OAAvB,EACfc,EADe,CACZ,WADY,EACCJ,OADD,EAEfI,EAFe,CAEZ,OAFY,EAEHH,MAFG,CAAlB;;AAIAT,MAAAA,MAAM,CAACa,IAAP,CAAYH,SAAZ;AACD,KANM,CAAP;AAOD,GA5Ba;AA6BdC,EAAAA,iBA7Bc,6BA6BIb,OA7BJ,EA6Ba;AACzBA,IAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACA,QAAMN,SAAS,GAAG,KAAKD,QAAL,CAAcuB,YAAd,CAA2BhB,OAAO,CAACiB,SAAnC,CAAlB;AAEA,QAAMC,WAAW,GAAGlB,OAAO,CAACkB,WAAR,IAAuB,CAAChC,KAAK,CAACiC,QAAP,EAAiB,YAAjB,EAA+B,YAA/B,CAA3C;;AACA,QAAMC,GAAG,GACPpB,OAAO,CAACoB,GAAR,IACA,UAASC,KAAT,EAAgB;AACd,UAAIA,KAAK,KAAK,EAAd,EAAkB;AAChB,eAAO,IAAP;AACD;;AACD,UAAMC,WAAW,GAAGC,MAAM,CAACF,KAAD,CAA1B;;AACA,UAAI,CAACE,MAAM,CAACC,KAAP,CAAaF,WAAb,CAAL,EAAgC;AAC9B,eAAOA,WAAP;AACD;;AACD,UAAMG,EAAE,GAAGvC,KAAK,CAACmC,KAAD,EAAQH,WAAR,EAAqB,IAArB,CAAhB;;AACA,UAAIO,EAAE,CAACC,OAAH,EAAJ,EAAkB;AAChB,eAAO,IAAIC,IAAJ,CAASF,EAAE,CAACG,OAAH,EAAT,CAAP;AACD;;AACD,UAAMC,OAAO,GAAGlC,aAAa,CAAC0B,KAAD,CAA7B;;AACA,UAAIQ,OAAO,KAAKC,SAAhB,EAA2B;AACzB,eAAOD,OAAP;AACD;;AACD,aAAOR,KAAP;AACD,KAnBH;;AAqBA,QAAMT,SAAS,GAAG3B,GAAG,CAACe,OAAD,CAAH,CACfc,EADe,CACZ,MADY,EACJ,UAAAiB,IAAI,EAAI;AAClBrC,MAAAA,SAAS,CAACsC,MAAV,CAAiBD,IAAI,CAACX,GAAL,CAASA,GAAT,CAAjB;AACD,KAHe,EAIfN,EAJe,CAIZ,KAJY,EAIL,YAAM;AACfF,MAAAA,SAAS,CAACqB,IAAV,CAAe,WAAf,EAA4BvC,SAA5B;AACD,KANe,CAAlB;AAOA,WAAOkB,SAAP;AACD,GA/Da;AAiEdsB,EAAAA,KAjEc,iBAiERhC,MAjEQ,EAiEAF,OAjEA,EAiES;AAAA;;AACrB,WAAO,IAAIb,UAAU,CAACsB,OAAf,CAAuB,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACjDX,MAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB,CADiD,CAEjD;AACA;AACA;;AAEA,UAAMN,SAAS,GAAG,MAAI,CAACD,QAAL,CAAc0C,YAAd,CAA2BnC,OAAO,CAACiB,SAAR,IAAqBjB,OAAO,CAACoC,OAAxD,CAAlB;;AAEA,UAAMxB,SAAS,GAAG3B,GAAG,CAACoD,iBAAJ,CAAsBrC,OAAtB,CAAlB;AACAE,MAAAA,MAAM,CAACY,EAAP,CAAU,QAAV,EAAoB,YAAM;AACxBJ,QAAAA,OAAO;AACR,OAFD;AAGAE,MAAAA,SAAS,CAACE,EAAV,CAAa,OAAb,EAAsBH,MAAtB;AACAC,MAAAA,SAAS,CAACG,IAAV,CAAeb,MAAf;AAbiD,qBAejBF,OAfiB;AAAA,UAezCsC,UAfyC,YAezCA,UAfyC;AAAA,UAe7BC,OAf6B,YAe7BA,OAf6B;;AAgBjD,UAAMnB,GAAG,GACPpB,OAAO,CAACoB,GAAR,IACC,UAAAoB,KAAK,EAAI;AACR,YAAIA,KAAJ,EAAW;AACT,cAAIA,KAAK,CAACC,IAAN,IAAcD,KAAK,CAACE,SAAxB,EAAmC;AACjC,mBAAOF,KAAK,CAACE,SAAN,IAAmBF,KAAK,CAACC,IAAzB,IAAiC,EAAxC;AACD;;AACD,cAAID,KAAK,CAACG,OAAN,IAAiBH,KAAK,CAACI,MAA3B,EAAmC;AACjC,mBAAOJ,KAAK,CAACI,MAAN,IAAgB,EAAvB;AACD;;AACD,cAAIJ,KAAK,YAAYb,IAArB,EAA2B;AACzB,gBAAIW,UAAJ,EAAgB;AACd,qBAAOC,OAAO,GAAGrD,KAAK,CAAC2D,GAAN,CAAUL,KAAV,EAAiBM,MAAjB,CAAwBR,UAAxB,CAAH,GAAyCpD,KAAK,CAACsD,KAAD,CAAL,CAAaM,MAAb,CAAoBR,UAApB,CAAvD;AACD;;AACD,mBAAOC,OAAO,GAAGrD,KAAK,CAAC2D,GAAN,CAAUL,KAAV,EAAiBM,MAAjB,EAAH,GAA+B5D,KAAK,CAACsD,KAAD,CAAL,CAAaM,MAAb,EAA7C;AACD;;AACD,cAAIN,KAAK,CAAC5C,KAAV,EAAiB;AACf,mBAAO4C,KAAK,CAAC5C,KAAb;AACD;;AACD,cAAI,QAAO4C,KAAP,MAAiB,QAArB,EAA+B;AAC7B,mBAAOO,IAAI,CAACC,SAAL,CAAeR,KAAf,CAAP;AACD;AACF;;AACD,eAAOA,KAAP;AACD,OAxBH;;AA0BA,UAAMS,gBAAgB,GAAGjD,OAAO,CAACiD,gBAAR,KAA6BnB,SAA7B,IAA0C9B,OAAO,CAACiD,gBAA3E;AACA,UAAIC,OAAO,GAAG,CAAd;;AACA,UAAIxD,SAAJ,EAAe;AACbA,QAAAA,SAAS,CAACyD,OAAV,CAAkB,UAACC,GAAD,EAAMC,SAAN,EAAoB;AACpC,cAAIJ,gBAAJ,EAAsB;AACpB,mBAAOC,OAAO,KAAKG,SAAS,GAAG,CAA/B,EAAkC;AAChCzC,cAAAA,SAAS,CAACsB,KAAV,CAAgB,EAAhB;AACD;AACF;;AALmC,cAM5BoB,MAN4B,GAMjBF,GANiB,CAM5BE,MAN4B;AAOpCA,UAAAA,MAAM,CAACC,KAAP;AACA3C,UAAAA,SAAS,CAACsB,KAAV,CAAgBoB,MAAM,CAAClC,GAAP,CAAWA,GAAX,CAAhB;AACA8B,UAAAA,OAAO,GAAGG,SAAV;AACD,SAVD;AAWD;;AACDzC,MAAAA,SAAS,CAAC4C,GAAV;AACD,KA1DM,CAAP;AA2DD,GA7Ha;AA8HdC,EAAAA,SA9Hc,qBA8HJ1D,QA9HI,EA8HMC,OA9HN,EA8He;AAC3BA,IAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AAEA,QAAM0D,aAAa,GAAG;AACpBC,MAAAA,QAAQ,EAAE3D,OAAO,CAAC2D,QAAR,IAAoB;AADV,KAAtB;AAGA,QAAMzD,MAAM,GAAGnB,EAAE,CAACsD,iBAAH,CAAqBtC,QAArB,EAA+B2D,aAA/B,CAAf;AAEA,WAAO,KAAKxB,KAAL,CAAWhC,MAAX,EAAmBF,OAAnB,CAAP;AACD,GAvIa;AAwId4D,EAAAA,WAxIc,uBAwIF5D,OAxIE,EAwIO;AACnB,QAAMC,IAAI,GAAG,IAAb;AACA,QAAMC,MAAM,GAAG,IAAId,SAAJ,EAAf;AACA,WAAOa,IAAI,CAACiC,KAAL,CAAWhC,MAAX,EAAmBF,OAAnB,EAA4BI,IAA5B,CAAiC;AAAA,aAAMF,MAAM,CAACK,IAAP,EAAN;AAAA,KAAjC,CAAP;AACD;AA5Ia,CAAhB","sourcesContent":["'use strict';\r\n\r\nconst fs = require('fs');\r\nconst csv = require('fast-csv');\r\nconst dayjs = require('dayjs');\r\nconst PromiseLib = require('../utils/promise');\r\nconst StreamBuf = require('../utils/stream-buf');\r\n\r\nconst utils = require('../utils/utils');\r\n\r\nconst CSV = (module.exports = function(workbook) {\r\n  this.workbook = workbook;\r\n  this.worksheet = null;\r\n});\r\n\r\n/* eslint-disable quote-props */\r\nconst SpecialValues = {\r\n  true: true,\r\n  false: false,\r\n  '#N/A': { error: '#N/A' },\r\n  '#REF!': { error: '#REF!' },\r\n  '#NAME?': { error: '#NAME?' },\r\n  '#DIV/0!': { error: '#DIV/0!' },\r\n  '#NULL!': { error: '#NULL!' },\r\n  '#VALUE!': { error: '#VALUE!' },\r\n  '#NUM!': { error: '#NUM!' },\r\n};\r\n/* eslint-ensable quote-props */\r\n\r\nCSV.prototype = {\r\n  readFile(filename, options) {\r\n    const self = this;\r\n    options = options || {};\r\n    let stream;\r\n    return utils.fs\r\n      .exists(filename)\r\n      .then(exists => {\r\n        if (!exists) {\r\n          throw new Error(`File not found: ${filename}`);\r\n        }\r\n        stream = fs.createReadStream(filename);\r\n        return self.read(stream, options);\r\n      })\r\n      .then(worksheet => {\r\n        stream.close();\r\n        return worksheet;\r\n      });\r\n  },\r\n  read(stream, options) {\r\n    options = options || {};\r\n    return new PromiseLib.Promise((resolve, reject) => {\r\n      const csvStream = this.createInputStream(options)\r\n        .on('worksheet', resolve)\r\n        .on('error', reject);\r\n\r\n      stream.pipe(csvStream);\r\n    });\r\n  },\r\n  createInputStream(options) {\r\n    options = options || {};\r\n    const worksheet = this.workbook.addWorksheet(options.sheetName);\r\n\r\n    const dateFormats = options.dateFormats || [dayjs.ISO_8601, 'MM-DD-YYYY', 'YYYY-MM-DD'];\r\n    const map =\r\n      options.map ||\r\n      function(datum) {\r\n        if (datum === '') {\r\n          return null;\r\n        }\r\n        const datumNumber = Number(datum);\r\n        if (!Number.isNaN(datumNumber)) {\r\n          return datumNumber;\r\n        }\r\n        const dt = dayjs(datum, dateFormats, true);\r\n        if (dt.isValid()) {\r\n          return new Date(dt.valueOf());\r\n        }\r\n        const special = SpecialValues[datum];\r\n        if (special !== undefined) {\r\n          return special;\r\n        }\r\n        return datum;\r\n      };\r\n\r\n    const csvStream = csv(options)\r\n      .on('data', data => {\r\n        worksheet.addRow(data.map(map));\r\n      })\r\n      .on('end', () => {\r\n        csvStream.emit('worksheet', worksheet);\r\n      });\r\n    return csvStream;\r\n  },\r\n\r\n  write(stream, options) {\r\n    return new PromiseLib.Promise((resolve, reject) => {\r\n      options = options || {};\r\n      // const encoding = options.encoding || 'utf8';\r\n      // const separator = options.separator || ',';\r\n      // const quoteChar = options.quoteChar || '\\'';\r\n\r\n      const worksheet = this.workbook.getWorksheet(options.sheetName || options.sheetId);\r\n\r\n      const csvStream = csv.createWriteStream(options);\r\n      stream.on('finish', () => {\r\n        resolve();\r\n      });\r\n      csvStream.on('error', reject);\r\n      csvStream.pipe(stream);\r\n\r\n      const { dateFormat, dateUTC } = options;\r\n      const map =\r\n        options.map ||\r\n        (value => {\r\n          if (value) {\r\n            if (value.text || value.hyperlink) {\r\n              return value.hyperlink || value.text || '';\r\n            }\r\n            if (value.formula || value.result) {\r\n              return value.result || '';\r\n            }\r\n            if (value instanceof Date) {\r\n              if (dateFormat) {\r\n                return dateUTC ? dayjs.utc(value).format(dateFormat) : dayjs(value).format(dateFormat);\r\n              }\r\n              return dateUTC ? dayjs.utc(value).format() : dayjs(value).format();\r\n            }\r\n            if (value.error) {\r\n              return value.error;\r\n            }\r\n            if (typeof value === 'object') {\r\n              return JSON.stringify(value);\r\n            }\r\n          }\r\n          return value;\r\n        });\r\n\r\n      const includeEmptyRows = options.includeEmptyRows === undefined || options.includeEmptyRows;\r\n      let lastRow = 1;\r\n      if (worksheet) {\r\n        worksheet.eachRow((row, rowNumber) => {\r\n          if (includeEmptyRows) {\r\n            while (lastRow++ < rowNumber - 1) {\r\n              csvStream.write([]);\r\n            }\r\n          }\r\n          const { values } = row;\r\n          values.shift();\r\n          csvStream.write(values.map(map));\r\n          lastRow = rowNumber;\r\n        });\r\n      }\r\n      csvStream.end();\r\n    });\r\n  },\r\n  writeFile(filename, options) {\r\n    options = options || {};\r\n\r\n    const streamOptions = {\r\n      encoding: options.encoding || 'utf8',\r\n    };\r\n    const stream = fs.createWriteStream(filename, streamOptions);\r\n\r\n    return this.write(stream, options);\r\n  },\r\n  writeBuffer(options) {\r\n    const self = this;\r\n    const stream = new StreamBuf();\r\n    return self.write(stream, options).then(() => stream.read());\r\n  },\r\n};\r\n"],"file":"csv.js"}