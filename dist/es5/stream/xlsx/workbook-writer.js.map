{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-writer.js"],"names":["fs","require","Archiver","PromiseLib","StreamBuf","RelType","StylesXform","SharedStrings","DefinedNames","CoreXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","SharedStringsXform","WorksheetWriter","theme1Xml","WorkbookWriter","module","exports","options","created","Date","modified","creator","lastModifiedBy","lastPrinted","useSharedStrings","sharedStrings","styles","useStyles","Mock","_definedNames","_worksheets","views","zipOptions","zip","media","stream","filename","createWriteStream","pipe","promise","Promise","all","addThemes","addOfficeRels","prototype","definedNames","_openStream","path","self","bufSize","batch","append","name","on","emit","_commitWorksheets","commitWorksheet","worksheet","committed","resolve","commit","promises","map","length","then","addContentTypes","addApp","addCore","addSharedStrings","addStyles","addWorkbookRels","addWorkbook","_finalize","nextId","i","addWorksheet","undefined","tabColor","console","trace","properties","Object","assign","id","workbook","state","pageSetup","autoFilter","getWorksheet","find","xml","xform","toXml","Id","Type","OfficeDocument","Target","CoreProperties","ExtenderProperties","model","worksheets","filter","Boolean","coreXform","count","sharedStringsXform","relationships","Styles","Theme","push","forEach","rId","Worksheet","prepare","reject","finalize"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nconst fs = require('fs');\r\nconst Archiver = require('archiver');\r\nconst PromiseLib = require('../../utils/promise');\r\n\r\nconst StreamBuf = require('../../utils/stream-buf');\r\n\r\nconst RelType = require('../../xlsx/rel-type');\r\nconst StylesXform = require('../../xlsx/xform/style/styles-xform');\r\nconst SharedStrings = require('../../utils/shared-strings');\r\nconst DefinedNames = require('../../doc/defined-names');\r\n\r\nconst CoreXform = require('../../xlsx/xform/core/core-xform');\r\nconst RelationshipsXform = require('../../xlsx/xform/core/relationships-xform');\r\nconst ContentTypesXform = require('../../xlsx/xform/core/content-types-xform');\r\nconst AppXform = require('../../xlsx/xform/core/app-xform');\r\nconst WorkbookXform = require('../../xlsx/xform/book/workbook-xform');\r\nconst SharedStringsXform = require('../../xlsx/xform/strings/shared-strings-xform');\r\n\r\nconst WorksheetWriter = require('./worksheet-writer');\r\n\r\nconst theme1Xml = require('../../xlsx/xml/theme1.js');\r\n\r\nconst WorkbookWriter = (module.exports = function(options) {\r\n  options = options || {};\r\n\r\n  this.created = options.created || new Date();\r\n  this.modified = options.modified || this.created;\r\n  this.creator = options.creator || 'ExcelJS';\r\n  this.lastModifiedBy = options.lastModifiedBy || 'ExcelJS';\r\n  this.lastPrinted = options.lastPrinted;\r\n\r\n  // using shared strings creates a smaller xlsx file but may use more memory\r\n  this.useSharedStrings = options.useSharedStrings || false;\r\n  this.sharedStrings = new SharedStrings();\r\n\r\n  // style manager\r\n  this.styles = options.useStyles ? new StylesXform(true) : new StylesXform.Mock(true);\r\n\r\n  // defined names\r\n  this._definedNames = new DefinedNames();\r\n\r\n  this._worksheets = [];\r\n  this.views = [];\r\n\r\n  this.zipOptions = options.zip;\r\n\r\n  this.media = [];\r\n\r\n  this.zip = Archiver('zip', this.zipOptions);\r\n  if (options.stream) {\r\n    this.stream = options.stream;\r\n  } else if (options.filename) {\r\n    this.stream = fs.createWriteStream(options.filename);\r\n  } else {\r\n    this.stream = new StreamBuf();\r\n  }\r\n  this.zip.pipe(this.stream);\r\n\r\n  // these bits can be added right now\r\n  this.promise = PromiseLib.Promise.all([this.addThemes(), this.addOfficeRels()]);\r\n});\r\n\r\nWorkbookWriter.prototype = {\r\n  get definedNames() {\r\n    return this._definedNames;\r\n  },\r\n\r\n  _openStream(path) {\r\n    const self = this;\r\n    const stream = new StreamBuf({ bufSize: 65536, batch: true });\r\n    self.zip.append(stream, { name: path });\r\n    stream.on('finish', () => {\r\n      stream.emit('zipped');\r\n    });\r\n    return stream;\r\n  },\r\n  _commitWorksheets() {\r\n    const commitWorksheet = function(worksheet) {\r\n      if (!worksheet.committed) {\r\n        return new PromiseLib.Promise(resolve => {\r\n          worksheet.stream.on('zipped', () => {\r\n            resolve();\r\n          });\r\n          worksheet.commit();\r\n        });\r\n      }\r\n      return PromiseLib.Promise.resolve();\r\n    };\r\n    // if there are any uncommitted worksheets, commit them now and wait\r\n    const promises = this._worksheets.map(commitWorksheet);\r\n    if (promises.length) {\r\n      return PromiseLib.Promise.all(promises);\r\n    }\r\n    return PromiseLib.Promise.resolve();\r\n  },\r\n\r\n  commit() {\r\n    // commit all worksheets, then add suplimentary files\r\n    return this.promise\r\n      .then(() => this._commitWorksheets())\r\n      .then(() =>\r\n        PromiseLib.Promise.all([this.addContentTypes(), this.addApp(), this.addCore(), this.addSharedStrings(), this.addStyles(), this.addWorkbookRels()])\r\n      )\r\n      .then(() => this.addWorkbook())\r\n      .then(() => this._finalize());\r\n  },\r\n  get nextId() {\r\n    // find the next unique spot to add worksheet\r\n    let i;\r\n    for (i = 1; i < this._worksheets.length; i++) {\r\n      if (!this._worksheets[i]) {\r\n        return i;\r\n      }\r\n    }\r\n    return this._worksheets.length || 1;\r\n  },\r\n  addWorksheet(name, options) {\r\n    // it's possible to add a worksheet with different than default\r\n    // shared string handling\r\n    // in fact, it's even possible to switch it mid-sheet\r\n    options = options || {};\r\n    const useSharedStrings = options.useSharedStrings !== undefined ? options.useSharedStrings : this.useSharedStrings;\r\n\r\n    if (options.tabColor) {\r\n      // eslint-disable-next-line no-console\r\n      console.trace('tabColor option has moved to { properties: tabColor: {...} }');\r\n      options.properties = Object.assign(\r\n        {\r\n          tabColor: options.tabColor,\r\n        },\r\n        options.properties\r\n      );\r\n    }\r\n\r\n    const id = this.nextId;\r\n    name = name || `sheet${id}`;\r\n\r\n    const worksheet = new WorksheetWriter({\r\n      id,\r\n      name,\r\n      workbook: this,\r\n      useSharedStrings,\r\n      properties: options.properties,\r\n      state: options.state,\r\n      pageSetup: options.pageSetup,\r\n      views: options.views,\r\n      autoFilter: options.autoFilter,\r\n    });\r\n\r\n    this._worksheets[id] = worksheet;\r\n    return worksheet;\r\n  },\r\n  getWorksheet(id) {\r\n    if (id === undefined) {\r\n      return this._worksheets.find(() => true);\r\n    }\r\n    if (typeof id === 'number') {\r\n      return this._worksheets[id];\r\n    }\r\n    if (typeof id === 'string') {\r\n      return this._worksheets.find(worksheet => worksheet && worksheet.name === id);\r\n    }\r\n    return undefined;\r\n  },\r\n  addStyles() {\r\n    const self = this;\r\n    return new PromiseLib.Promise(resolve => {\r\n      self.zip.append(self.styles.xml, { name: 'xl/styles.xml' });\r\n      resolve();\r\n    });\r\n  },\r\n  addThemes() {\r\n    const self = this;\r\n    return new PromiseLib.Promise(resolve => {\r\n      self.zip.append(theme1Xml, { name: 'xl/theme/theme1.xml' });\r\n      resolve();\r\n    });\r\n  },\r\n  addOfficeRels() {\r\n    const self = this;\r\n    return new PromiseLib.Promise(resolve => {\r\n      const xform = new RelationshipsXform();\r\n      const xml = xform.toXml([\r\n        { Id: 'rId1', Type: RelType.OfficeDocument, Target: 'xl/workbook.xml' },\r\n        { Id: 'rId2', Type: RelType.CoreProperties, Target: 'docProps/core.xml' },\r\n        { Id: 'rId3', Type: RelType.ExtenderProperties, Target: 'docProps/app.xml' },\r\n      ]);\r\n      self.zip.append(xml, { name: '/_rels/.rels' });\r\n      resolve();\r\n    });\r\n  },\r\n\r\n  addContentTypes() {\r\n    return new PromiseLib.Promise(resolve => {\r\n      const model = {\r\n        worksheets: this._worksheets.filter(Boolean),\r\n        sharedStrings: this.sharedStrings,\r\n      };\r\n      const xform = new ContentTypesXform();\r\n      const xml = xform.toXml(model);\r\n      this.zip.append(xml, { name: '[Content_Types].xml' });\r\n      resolve();\r\n    });\r\n  },\r\n  addApp() {\r\n    return new PromiseLib.Promise(resolve => {\r\n      const model = {\r\n        worksheets: this._worksheets.filter(Boolean),\r\n      };\r\n      const xform = new AppXform();\r\n      const xml = xform.toXml(model);\r\n      this.zip.append(xml, { name: 'docProps/app.xml' });\r\n      resolve();\r\n    });\r\n  },\r\n  addCore() {\r\n    const self = this;\r\n    return new PromiseLib.Promise(resolve => {\r\n      const coreXform = new CoreXform();\r\n      const xml = coreXform.toXml(self);\r\n      self.zip.append(xml, { name: 'docProps/core.xml' });\r\n      resolve();\r\n    });\r\n  },\r\n  addSharedStrings() {\r\n    const self = this;\r\n    if (this.sharedStrings.count) {\r\n      return new PromiseLib.Promise(resolve => {\r\n        const sharedStringsXform = new SharedStringsXform();\r\n        const xml = sharedStringsXform.toXml(self.sharedStrings);\r\n        self.zip.append(xml, { name: '/xl/sharedStrings.xml' });\r\n        resolve();\r\n      });\r\n    }\r\n    return PromiseLib.Promise.resolve();\r\n  },\r\n  addWorkbookRels() {\r\n    const self = this;\r\n    let count = 1;\r\n    const relationships = [\r\n      { Id: `rId${count++}`, Type: RelType.Styles, Target: 'styles.xml' },\r\n      { Id: `rId${count++}`, Type: RelType.Theme, Target: 'theme/theme1.xml' },\r\n    ];\r\n    if (this.sharedStrings.count) {\r\n      relationships.push({ Id: `rId${count++}`, Type: RelType.SharedStrings, Target: 'sharedStrings.xml' });\r\n    }\r\n    this._worksheets.forEach(worksheet => {\r\n      if (worksheet) {\r\n        worksheet.rId = `rId${count++}`;\r\n        relationships.push({ Id: worksheet.rId, Type: RelType.Worksheet, Target: `worksheets/sheet${worksheet.id}.xml` });\r\n      }\r\n    });\r\n    return new PromiseLib.Promise(resolve => {\r\n      const xform = new RelationshipsXform();\r\n      const xml = xform.toXml(relationships);\r\n      self.zip.append(xml, { name: '/xl/_rels/workbook.xml.rels' });\r\n      resolve();\r\n    });\r\n  },\r\n  addWorkbook() {\r\n    const { zip } = this;\r\n    const model = {\r\n      worksheets: this._worksheets.filter(Boolean),\r\n      definedNames: this._definedNames.model,\r\n      views: this.views,\r\n      properties: {},\r\n    };\r\n\r\n    return new PromiseLib.Promise(resolve => {\r\n      const xform = new WorkbookXform();\r\n      xform.prepare(model);\r\n      zip.append(xform.toXml(model), { name: '/xl/workbook.xml' });\r\n      resolve();\r\n    });\r\n  },\r\n  _finalize() {\r\n    return new PromiseLib.Promise((resolve, reject) => {\r\n      this.stream.on('error', reject);\r\n      this.stream.on('finish', () => {\r\n        resolve(this);\r\n      });\r\n      this.zip.on('error', reject);\r\n\r\n      this.zip.finalize();\r\n    });\r\n  },\r\n};\r\n"],"file":"workbook-writer.js"}